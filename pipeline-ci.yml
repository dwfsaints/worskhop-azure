trigger: 
  - main

pool: 
  vmImage: 'ubuntu-latest'

variables:
  - group: Workshop
  - name: currentRepository
    value: $(Build.Repository.Name)
  - name: prNumber
    value: $(System.PullRequest.PullRequestNumber) 

steps: 
  - script: |
      git config --local user.name "Azure Pipelines"
      git config --local user.email "azuredevops@microsoft.com"
    displayName: 'Git credentials' 
  - task: Npm@1
    inputs:
      command: "install"
    displayName: "Installing dependencies"
  # - task: Npm@1
  #   inputs:
  #     command: "custom"
  #     customCommand: 'run test'
  #   displayName: "Testing App"
  - task: Npm@1
    inputs:
      command: "custom"
      customCommand: 'run build -- --base-href "https://dwfsaints.github.io/worskhop-azure/ci/$(prNumber)/app"'
    displayName: "Build Angular App"
  
  - task: Npm@1
    inputs:
      command: "custom"
      customCommand: 'run deploy -- -r "https://x-access-token:$(GITHUB_TOKEN)@github.com/$(currentRepository).git" -e ci/$(prNumber)'
    displayName: "Deploy Angular App"
    condition: succeeded()

  - task: CmdLine@2
    inputs:
      script: |
        curl \
        -X POST \
        "https://api.github.com/repos/$(currentRepository)/issues/$(prNumber)/comments" \
        -H "Content-Type: application/json" \
        -H "Authorization: token $(GITHUB_TOKEN)" \
        --data '{ "body": "[Angular App](https://dwfsaints.github.io/worskhop-azure/ci/$(prNumber))" }'
    displayName: 'Comment link on PR'
    condition: succeeded() 
